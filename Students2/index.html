<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FORM THÔNG TIN HỌC VIÊN</title>
    <style>
      .infoStudent tr {
        display: flex;
        flex-direction: column;
        margin-right: 20px;
      }
      .infoStudent tbody {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
      .infoStudent td {
        height: 30px;
      }
      body,
      .infoStudent form {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .infoStudent .submit {
        bottom: 0px;
      }

      .listStudent td,
      .listStudent th,
      .listStudent table {
        border: 1px solid black;
      }
      .listStudentTableTbody span {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Thông tin học viên</h2>
    <form action="/action_page.php" class="infoStudent">
      <table>
        <tbody>
          <tr>
            <td><label for="name"> Họ và tên</label></td>
            <td><label for="email"> Email </label></td>
            <td><label for="phone"> Số điện thoại</label></td>
            <td><label for="address">Quê quán</label></td>
            <td><label for="gender">Giới tính</label></td>
          </tr>
          <tr>
            <td>
              <input
                type="text"
                id="name"
                class="name"
                required
                placeholder="Họ và tên"
              /><br />
            </td>
            <td>
              <input
                type="email"
                id="email"
                name="email"
                class="email"
                required
                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$"
                placeholder="Email"
              /><br />
            </td>
            <td>
              <input
                type="tel"
                id="phone"
                class="phone"
                pattern="[0-9]{4}[0-9]{3}[0-9]{3}"
                required
                placeholder="0123456789"
              /><br />
            </td>
            <td>
              <input
                type="text"
                id="address"
                class="address"
                placeholder="Địa chỉ"
                required
              /><br />
            </td>
            <td>
              <input
                name="gender"
                type="radio"
                id="man"
                class="gender"
                checked
                onclick="checkGender()"
              />
              <label for="man">Nam</label>
              <input
                name="gender"
                type="radio"
                id="woman"
                class="gender"
                onclick="checkGender()"
              />
              <label for="woman">Nữ</label><br />
            </td>
          </tr>
        </tbody>
      </table>
      <input class="save" type="submit" value="Save" />
      <label class="notification"></label>
    </form>

    <form action="" class="listStudent">
      <h2>Danh sách học viên</h2>
      <label for="findStudent">Tìm kiếm theo tên học viên: </label>
      <input type="text" placeholder="Nhập vào tên học viên" id="findStudent" />
      <input type="submit" value="Search" onclick="findStudents(event)" /><br />
      <span class="searchNotice"></span>
      <table>
        <thead>
          <tr>
            <th>STT</th>
            <th>Họ tên</th>
            <th>Email</th>
            <th>Điện thoại</th>
            <th>Địa chỉ</th>
            <th>Giới tính</th>
            <th>Hành động</th>
            <th>
              <button class="sortName" type="button" onclick="sortStudents()">
                Sắp xếp theo tên
              </button>
            </th>
          </tr>
        </thead>
        <tbody class="listStudentTableTbody"></tbody>
      </table>
    </form>

    <script>
      let studentArr = JSON.parse(localStorage.getItem("student")) || [];
      renderStudents();
      let status = false;
      //Tạo hàm render userStudent
      function renderStudents() {
        let html = "";
        studentArr.forEach((item, id, arr) => {
          html += `
                            <tr>
                              <td>${id + 1}</td>
                              <td>${arr[id].name}</td>
                              <td>${arr[id].email}</td>
                              <td>${arr[id].phone}</td>
                              <td>${arr[id].address}</td>
                              <td>${arr[id].gender}</td>
                              <td><span onclick=editStudentS(${
                                arr[id].id
                              })>edit</span> | <span onclick=deleteStudents(${
            arr[id].id
          })>delete</span></td>
                            </tr>
                                      `;
        });

        document.getElementsByClassName(
          "listStudentTableTbody"
        )[0].innerHTML = `${html}`;
      }

      //Thêm sinh viên
      function addStudent(event) {
        event.preventDefault();
        let name = document.getElementById("name").value;
        let email = document.getElementById("email").value;
        let phone = document.getElementById("phone").value;
        let address = document.getElementById("address").value;

        if (name == "" || email == "" || phone == "" || address == "") {
          document.getElementsByClassName("notification")[0].innerHTML =
            "Vui lòng nhập đầy đủ thông tin";
          return;
        }
        students = {
          name: name,
          email: email,
          phone: phone,
          address: address,
          gender: checkGender(),
          id: uuid(),
        };

        let checkEmail = -1;
        studentArr.forEach((item) => {
          if (email == item.email) {
            checkEmail = item.id;
          }
        });
        if (checkEmail !== -1) {
          console.log("Email đã được nhập, vui lòng nhập email khác");
          document.getElementsByClassName("notification")[0].innerHTML =
            "Email đã được nhập, vui lòng nhập email khác";
          return;
        }
        studentArr.push(students);
        console.log("mảng thêm vào", studentArr);
        localStorage.setItem("student", JSON.stringify(studentArr));
        renderStudents();
        document.getElementsByClassName("notification")[0].innerHTML = "";
        inputForm("", "", "", "");
      }

      //Kiểm tra gender
      function checkGender() {
        let gender = document.getElementsByClassName("gender")[0];
        if (gender.checked) {
          console.log("Nam");
          return "Nam";
        } else {
          console.log("nữ");
          return "Nữ";
        }
      }

      //delete student
      function deleteStudents(id) {
        let confirmDelete = confirm("Bạn có muốn xóa hay không");
        if (!confirmDelete) {
          return;
        }
        let index = studentArr.findIndex((item) => {
          return item.id == id;
        });

        studentArr.splice(index, 1);
        console.log("Đã xóa vị trí ", id);
        localStorage.setItem("student", JSON.stringify(studentArr));
        renderStudents();
      }

      //gọi form
      function inputForm(name, email, phone, address) {
        document.getElementById("name").value = name;
        document.getElementById("email").value = email;
        document.getElementById("phone").value = phone;
        document.getElementById("address").value = address;
      }

      //Hàm sửa
      function editStudentS(id) {
        console.log("Chạy vào hàm sửa");
        let index = studentArr.findIndex((item) => {
          return item.id == id;
        });

        inputForm(
          studentArr[index].name,
          studentArr[index].email,
          studentArr[index].phone,
          studentArr[index].address
        );

        let editGender = document.getElementsByClassName("gender");
        if (studentArr[index].gender === "Nữ") {
          editGender[0].checked = false;
          editGender[1].checked = true;
        } else {
          editGender[0].checked = true;
          editGender[1].checked = false;
        }
        console.log("sửa phần tử thứ id", id);
        status = true;
        if (status) {
          console.log("status", status);
          document
            .getElementsByClassName("save")[0]
            .addEventListener("click", () => {
              console.log("sửa phần tử thứ index", studentArr[index]);
              studentArr.splice(index, 1);
              addStudent(event);
            });
          status = false;
        }

        //Kiểm tra mảng edit có trùng hay không
      }

      if (!status) {
        document
          .getElementsByClassName("save")[0]
          .addEventListener("click", () => {
            addStudent(event);
          });
      }

      let temp = 0;
      // Sắp xếp theo alpha b
      function sortStudents() {
        if (temp == 0) {
          temp = 1;
          studentArr.sort((a, b) => {
            return a.name.localeCompare(b.name);
          });
        } else {
          temp = 0;
          studentArr.sort((a, b) => {
            return b.name.localeCompare(a.name);
          });
        }
        console.log("Mảng sau khi sort", studentArr);
        localStorage.setItem("student", JSON.stringify(studentArr));
        renderStudents();
      }

      //Tạo hàm id ngẫu nhiên
      function uuid() {
        return Math.floor(
          Math.random() * 999999 + new Date().getMilliseconds()
        );
      }

      function findStudents() {
        let notExist = document.getElementsByClassName("searchNotice")[0];
        let inputSearch = document.getElementById("findStudent");
        event.preventDefault();
        console.log("chạy vào hàm find");
        let check = false;
        let searchArr = [];
        let name = document.getElementById("findStudent").value;
        studentArr.forEach((item, index, arr) => {
          if (arr[index].name == name) {
            searchArr.push(arr[index]);
            console.log(searchArr);
            return (check = true);
          }
        });
        console.log("giá trị check", check);

        if (!check) {
          notExist.innerHTML = "Tên tìm kiếm không tồn tại";
          inputSearch.value = "";
          renderStudents();
        } else {
          notExist.innerHTML = "";
          let html = "";
          searchArr.forEach((item, index, arr) => {
            html += `
                            <tr>
                              <td>${index + 1}</td>
                              <td>${arr[index].name}</td>
                              <td>${arr[index].email}</td>
                              <td>${arr[index].phone}</td>
                              <td>${arr[index].address}</td>
                              <td>${arr[index].gender}</td>
                              <td><span onclick=editStudentS(${
                                arr[index].id
                              })>edit</span> | <span onclick=deleteStudents(${
              arr[index].id
            })>delete</span></td>
                            </tr>
                                      `;
          });
          document.getElementsByClassName(
            "listStudentTableTbody"
          )[0].innerHTML = `${html}`;
          inputSearch.value = "";
        }
      }

      //Làm sao ràng buộc nút sửa và nút thêm,
    </script>
  </body>
</html>
